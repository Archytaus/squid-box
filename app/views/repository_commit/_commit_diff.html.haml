.diff
  %table
    - before_count = 1
    - after_count = 1
    - line_count = 1

    - diff.each do |line|

      - line_comment = comments.find{|comment| line_count >= comment.start_line && line_count <= comment.end_line}

      %tr{:data => {:line => line_count}}
        - line_count += 1
        %td.add_comment
          = link_to "+", "#"
        %td.line-number-after
          #{after_count}
        %td.line-number-before
          #{before_count}

        - case line
        - when /^(---|\+\+\+|\\\\)/
          - before_count += 1
          - after_count += 1
          %td.line.diff-comment
            %pre
              #{line.chomp}
            .comment-line-background
        - when /^\+/
          - after_count += 1
          %td.line.ins
            %pre
              #{clean_line line}
            .comment-line-background
        - when /^-/
          - before_count += 1
          %td.line.del
            %pre
              #{clean_line line}
            .comment-line-background
        - when /^ /
          - before_count += 1
          - after_count += 1
          %td.line.unchanged
            %pre
              #{clean_line line}
            .comment-line-background
        - when /^@@/
          - before_count += 1
          - after_count += 1
          %td.line.diff-block-info
            %pre
              #{line.chomp}
            .comment-line-background

        %td.comments
          - if line_comment.present?
            - if line_comment.start_line == line_count - 1
              = render :partial => "comments/line", :locals => {:comment => line_comment}
